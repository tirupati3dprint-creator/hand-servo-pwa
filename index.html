<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hand → Servo (PWA)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: system-ui, sans-serif; margin: 12px; }
    h2 { margin: 6px 0 10px; }
    #status { margin: 8px 0 12px; min-height: 1.6em; }
    .vals { display:flex; gap:10px; flex-wrap:wrap; font-size:18px; }
    .chip { padding:6px 10px; border:1px solid #ddd; border-radius:10px; }
    video, canvas { width:100%; max-width:480px; border-radius:12px; }
    button { padding:10px 16px; margin: 8px 0; }
  </style>
  <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
  <!-- ✅ Use pinned versions -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1673/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640024915/camera_utils.js"></script>
</head>
<body>
  <h2>Hand → Servo (PWA)</h2>
  <div id="status">Ready. Tap Start and allow camera.</div>
  <button id="startBtn">Start Camera</button>

  <div class="vals">
    <div class="chip">Thumb: <b id="v0">0</b></div>
    <div class="chip">Index: <b id="v1">0</b></div>
    <div class="chip">Middle: <b id="v2">0</b></div>
    <div class="chip">Ring: <b id="v3">0</b></div>
    <div class="chip">Little: <b id="v4">0</b></div>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="out" width="640" height="480"></canvas>

<script>
  const videoEl = document.getElementById('video');
  const canvasEl = document.getElementById('out');
  const ctx = canvasEl.getContext('2d');
  const statusEl = document.getElementById('status');
  const vEls = [0,1,2,3,4].map(i=>document.getElementById('v'+i));

  function vAngle(a,b,c){
    const v1=[a.x-b.x,a.y-b.y,a.z-b.z], v2=[c.x-b.x,c.y-b.y,c.z-b.z];
    const dot=v1[0]*v2[0]+v1[1]*v2[1]+v1[2]*v2[2];
    const m1=Math.hypot(...v1), m2=Math.hypot(...v2);
    const cos=Math.min(1,Math.max(-1,dot/((m1*m2)+1e-9)));
    return Math.acos(cos)*180/Math.PI;
  }
  const ID={WRIST:0,THUMB_CMC:1,THUMB_MCP:2,THUMB_IP:3,THUMB_TIP:4,INDEX_MCP:5,INDEX_PIP:6,INDEX_DIP:7,INDEX_TIP:8,MIDDLE_MCP:9,MIDDLE_PIP:10,MIDDLE_DIP:11,MIDDLE_TIP:12,RING_MCP:13,RING_PIP:14,RING_DIP:15,RING_TIP:16,LITTLE_MCP:17,LITTLE_PIP:18,LITTLE_DIP:19,LITTLE_TIP:20};

  function fingerFlex(lm, tip, dip, pip, mcp){
    const a1=vAngle(lm[dip], lm[pip], lm[mcp]);   // PIP
    const a2=vAngle(lm[pip], lm[mcp], lm[0]);     // MCP vs wrist
    let flex=(a1-20)+(a2-20);
    return Math.max(0, Math.min(100, flex));
  }

  function onResults(results){
    ctx.clearRect(0,0,canvasEl.width,canvasEl.height);
    ctx.drawImage(results.image,0,0,canvasEl.width,canvasEl.height);
    if (results.multiHandLandmarks?.length){
      const lm = results.multiHandLandmarks[0];
      const vals = [
        fingerFlex(lm, ID.THUMB_TIP, ID.THUMB_IP, ID.THUMB_MCP, ID.THUMB_CMC),
        fingerFlex(lm, ID.INDEX_TIP, ID.INDEX_DIP, ID.INDEX_PIP, ID.INDEX_MCP),
        fingerFlex(lm, ID.MIDDLE_TIP,ID.MIDDLE_DIP,ID.MIDDLE_PIP,ID.MIDDLE_MCP),
        fingerFlex(lm, ID.RING_TIP,  ID.RING_DIP,  ID.RING_PIP,  ID.RING_MCP),
        fingerFlex(lm, ID.LITTLE_TIP,ID.LITTLE_DIP,ID.LITTLE_PIP,ID.LITTLE_MCP),
      ];
      vals.forEach((v,i)=>vEls[i].textContent = v.toFixed(0));
    }
  }

  document.getElementById('startBtn').onclick = async ()=>{
    try{
      // ✅ Use correct constructor: new Hands(...)
      const hands = new Hands({
        locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1673/${f}`
      });
      hands.setOptions({ maxNumHands:1, modelComplexity:1, minDetectionConfidence:0.6, minTrackingConfidence:0.6 });
      hands.onResults(onResults);

      const cam = new CameraUtils.Camera(videoEl, {
        onFrame: async ()=>{ await hands.send({image: videoEl}); },
        width:640, height:480
      });
      await cam.start();
      statusEl.textContent = 'Camera started. Show your hand.';
    }catch(err){
      statusEl.textContent = 'Camera failed: ' + err;
    }
  };
</script>
</body>
</html>
